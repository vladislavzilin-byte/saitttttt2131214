<full code from previous message omitted for brevity>